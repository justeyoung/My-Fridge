<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Download Inventory</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h2>Download Inventory PDFs by Location</h2>
  <div id="pdfContainer"></div>
  <a href="index.html" class="button home-button">Home</a>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyThkEhW3QIAIZcXhgvc5bfDgwZ8TG7wZqley13fHAqreh9FnohK37jcfPx8HlHgRXD/exec';

    fetch(scriptURL)
      .then(response => response.json())
      .then(data => renderPDFSections(data))
      .catch(err => {
        document.body.innerHTML = '<p style="color:red;">Error loading data.</p>';
        console.error(err);
      });

    function renderPDFSections(data) {
      const container = document.getElementById('pdfContainer');
      const grouped = {};

      data.forEach(row => {
        const location = row[7] || 'Unknown';
        if (!grouped[location]) grouped[location] = [];
        grouped[location].push(row);
      });

      Object.entries(grouped).forEach(([location, items]) => {
        const section = document.createElement('div');
        section.innerHTML = `
          <h3>Inventory - ${location}</h3>
          <table class="inventory-table">
            <thead>
              <tr>
                <th>#</th><th>Item</th><th>Quantity</th><th>Unit</th><th>Expiry Date</th>
              </tr>
            </thead>
            <tbody>
              ${items.map((row, index) => `
                <tr>
                  <td>${index + 1}</td>
                  <td>${row[1]}</td>
                  <td>${row[3]}</td>
                  <td>${row[4]}</td>
                  <td>${formatDate(row[6])}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <button onclick="downloadPDF(this.previousElementSibling, '${location}')">Print PDF</button>
        `;
        container.appendChild(section);
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return isNaN(date) ? '' : date.toLocaleDateString('en-GB');
    }

    function downloadPDF(table, location) {
      const title = `Inventory - ${location}`;
      const filename = `${location.replace(/\s+/g, '_')}_Inventory.pdf`;

      const wrapper = document.createElement('div');
      wrapper.style.padding = '20px';
      wrapper.style.background = 'white';
      wrapper.innerHTML = `<h2 style="text-align:center;">${title}</h2>` + table.outerHTML;

      document.body.appendChild(wrapper);

      html2canvas(wrapper).then(canvas => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL('image/png');
        const width = pdf.internal.pageSize.getWidth();
        const height = canvas.height * width / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 10, width, height);
        pdf.save(filename);
        document.body.removeChild(wrapper);
      });
    }
  </script>
</body>
</html>
